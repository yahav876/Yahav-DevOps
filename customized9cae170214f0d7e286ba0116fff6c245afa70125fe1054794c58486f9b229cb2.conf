#log type: gateway, vod nginx, edu nginx
<filter wjesapigateway.**>
  @type parser
  key_name message
  <parse>
    @type regexp
    expression  /^(?<clientip>[^ ]*)  (?:[^ ]*) (?<domainname>[^ ]*) \[(?<accesstime>[^\]]*)\] (?<requesttime>[^ ]*) (?:\S+) (?<api>[^? ]*)(?<param>[^ ]*)(?:[^"]*)"(?<statuscode>[^"]*)" (?:[^ ]*) "(?:[^"]*)" "(?<http_user_agent>[^"]*)" \S+ "\S+" (?<body>\{[^"]*\}) .*$/
    time_key accesstime
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</filter>
<match wjesapigateway.**>
  @type rewrite_tag_filter
  <rule>
    key domainname
    pattern /^params-msg-[^.]*\.vidaahub\.com$/
    tag wjesparambody.3.${tag}
  </rule>
  <rule>
    key domainname
    pattern /^domain\.vidaahub\.com$/
    tag wjesparambody.1.${tag}
  </rule>
  <rule>
    key domainname
    pattern /^domain\.intsmarthub\.com$/
    tag wjesparambody.2.${tag}
  </rule>
  <rule>
    key domainname
    pattern /.*/
    tag wjesparambody.0.${tag}
  </rule>
</match>
<filter wjesparambody.1.wjesapigateway.**>
  @type parser
  reserve_data true
  reserve_time true
  key_name body
  <parse>
    @type regexp
    expression   /^(?=.*?\\x22device_?[Ii]d\\x22:\\x22(?=(?<featurecode>[^\\]{24}))?(?<deviceid>[^\\]*))?(?=.*?\\x22capability_?[Cc]ode\\x22:\\x22(?<capabilitycode>[^\\]*))?(?=.*?\\x22app_?[Vv]ersion\\x22:\\x22(?<appversion>[^\\]*))?(?=.*?\\x22locale\\x22:\\x22(?<locale>[^\\]*))?(?=.*?\\x22brand\\x22:\\x22(?<brand>[^\\]*))?(?=.*?\\x22deviceType\\x22:\\x22(?<devicetype>[^\\]*))?.*/
  </parse>
</filter>
<filter wjesparambody.2.wjesapigateway.**>
  @type parser
  reserve_data true
  reserve_time true
  key_name body
  <parse>
    @type regexp
    expression   /^(?=.*?\\x22device_?[Ii]d\\x22:\\x22(?=(?<featurecode>[^\\]{24}))?(?<deviceid>[^\\]*))?(?=.*?\\x22capability_?[Cc]ode\\x22:\\x22(?<capabilitycode>[^\\]*))?(?=.*?\\x22brand\\x22:\\x22(?<brand>[^\\]*))?.*/
  </parse>
</filter>
<filter wjesparambody.3.wjesapigateway.**>
  @type parser
  reserve_data true
  reserve_time true
  key_name body
  <parse>
    @type regexp
    expression   /^(?=.*?\\x22channel\\x22:\\x22dev_(?=(?<featurecode>[^\\]{24}))?(?<deviceid>[^\\]*))?.*/
  </parse>
</filter>
<filter wjesparambody.0.wjesapigateway.**>
  @type parser
  reserve_data true
  reserve_time true
  key_name param
  <parse>
    @type regexp
    expression   /^(?=[^ ]*?[?&]device_?[Ii]d=(?=(?<featurecode>[^& ]{24}))?(?<deviceid>[^& ]*))?(?=[^ ]*[?&]capability_?[Cc]ode=(?<capabilitycode>[^& ]*))?(?=[^ ]*[?&]app_?[Vv]ersion=(?<appversion>[^& ]*))?(?=[^ ]*[?&]locale=(?<locale>[^& ]*))?(?=[^ ]*[?&]brand=(?<brand>[^& ]*))?(?=[^ ]*[?&]deviceType=(?<devicetype>[^& ]*))?(?=[^ ]*[?&]triggerInfo=(?<triggerinfo>[^& ]*))?.*/
  </parse>
</filter>
<filter wjesvod.**>
  @type parser
  key_name message
  <parse>
    @type regexp
    expression /^(?<clientip>[^ ]*) - (?<remote_user>[^ ]*) \[(?<accesstime>[^\]]*)\] (?:\S+) (?<api>[^? ]*)(?<param>[^ ]*) (?:\S+) "(?<statuscode>[^"]*)" \[(?<requesttime>[^ ]*) (?<upstreamresponsetime>[^\]]*)\] (?<body_bytes_sent>[^ ]*) "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)" "(?<http_x_forwarded_for>[^"]*)".*$/
    time_key accesstime
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</filter>
<filter nginx.edu.**>
  @type parser
  key_name message
  <parse>
    @type regexp
    expression /^(?<clientip>[^ ]*) - (?<remote_user>[^ ]*) \[(?<accesstime>[^\]]*)\] "(?:\S+) (?<api>[^? ]*)\??(?:([^"]*))" \[(?<statuscode>[^ ]*) (?<body_bytes_sent>[^ ]*) (?<requesttime>[^ ]*) (?<upstreamresponsetime>[^ ]*)\] "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)" "(?<http_x_forwarded_for>[^"]*)"$/
    time_key accesstime
    time_format %d/%b/%Y:%H:%M:%S %z
  </parse>
</filter>

#attack check
<match wjesparambody.*.wjesapigateway.** wjesvod.**>
  @type rewrite_tag_filter
  <rule>
    key http_user_agent
    pattern /HTTrack|harvest|audit|dirbuster|pangolin|nmap|sqln|-scan|hydra|Parser|libwww|BBBike|sqlmap|w3af|owasp|Nikto|fimap|havij|PycURL|zmeu|BabyKrokodil|netsparker|httperf|bench|SF/
    tag wjes.security.5.${tag}
  </rule>
  <rule>
    key param
    pattern /select|SELECT|Select|%20and%201=1|%20and%201=2|exec|information_schema.tables|where|union|table_name|xp_cmdshell|table_schema|insert|from|%EF%BC%87|%2531|%u0053%u0045|drop|declare|truncate|backup|exists|create|update|delete|sleep|having|waitfor|delay|group|benchmark|rename|desc|\/bin|\/sbin/
    tag wjes.security.1.${tag}
  </rule>
  <rule>
    key param
    pattern /\.zip|\.tar|\.tar\.gz|\.gz|\.log|\.sql|\.conf|\.old|\.bak|\.xml|\/etc|etc\/passwd|etc\/shadow|\/usr|\/var|\/proc|\/home|\/opt/
    tag wjes.security.2.${tag}
  </rule>
  <rule>
    key param
    pattern /<script|<\/script|script>|%3Cscript|%3C%2Fscript|script%3E|javascript|onerror|onclick|onload|<img|alert|document|cookie|expression|IMG%20|INPUT%20|iframe|onmouse|vbscript|applet|embed|frame|frameset/
    tag wjes.security.3.${tag}
  </rule>
  <rule>
    key param
    pattern /struts|jmx-console|ajax_membergroup.php|phpMyAdmin|getWriter|dirContext|phpmyadmin|\/e\/|\/SouthidcEditor\/|\/DatePicker\/|\/host-manager|\/manager|jmxinvokerservlet|denyMethodExecution|allowStaticMethodAccess|phpinfo|WEB-INF/
    tag wjes.security.4.${tag}
  </rule>
  <rule>
    key param
    pattern /%027|%00|%01|%7f|%2E%2E|%0A|%0D|\.\.\/\.\.|\.\.\\\.\.|echo|\.\.\/\.\.\/|%5C\.\.\/%5C|\.\/\.\/\.\/\.\/|2e%2e%5c%2e|\\x5C\\x5C|\.\.\/|%c0%ae%c0%ae|\.\./
    tag wjes.security.6.${tag}
  </rule>
  <rule>
    key statuscode
    pattern /.+/
    tag wjes.security.0.${tag}
  </rule>
</match>
<filter wjes.security.**>
  @type record_transformer
  remove_keys http_user_agent,body
</filter>
<filter wjes.security.**>
  @type record_transformer
  enable_ruby true
  <record>
    host_ip "#{ENV['HOST_NODENAME']}"
    security-check ${tag_parts[2]}
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S%z')}
    pod_name ${tag_parts[13].split('_')[0]}
#    container_name ${tag_parts[14]}
#    logdir ${tag_parts[15]}
#    logfile ${tag_suffix[17]}
    esindex k8s-${tag_parts[10]}-${tag_parts[11]}-${tag_parts[12]}-${time.strftime('%Y.%m.%d')}
  </record>
</filter>
<filter nginx.edu.**>
  @type record_transformer
  enable_ruby true
  <record>
    host_ip "#{ENV['HOST_NODENAME']}"
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S%z')}
    pod_name ${tag_parts[9].split('_')[0]}
#    container_name ${tag_parts[10]}
#    logdir ${tag_parts[11]}
#    logfile ${tag_suffix[13]}
    esindex k8s-${tag_parts[6]}-${tag_parts[7]}-${tag_parts[8]}-${time.strftime('%Y.%m.%d')}
  </record>
</filter>



