apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  annotations:
    meta.helm.sh/release-name: kube-prometheus-stack
    meta.helm.sh/release-namespace: monitoring
    prometheus-operator-validated: "true"
  labels:
    app: kube-prometheus-stack
    app.kubernetes.io/instance: kube-prometheus-stack
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: kube-prometheus-stack
    app.kubernetes.io/version: 49.0.0
    chart: kube-prometheus-stack-49.0.0
    heritage: Helm
    release: kube-prometheus-stack
  name: kube-prometheus-stack-kafka.rules
  namespace: monitoring
spec:
  groups:
  - name: KafkaExporter
    rules:

      - alert: KafkaTopicsReplicas
        expr: 'sum(kafka_topic_partition_in_sync_replica) by (topic) < 3'
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: Kafka topics replicas (instance {{ $labels.instance }})
          description: "Kafka topic in-sync partition\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

      - alert: KafkaConsumersGroup
        expr: 'sum(kafka_consumergroup_lag) by (consumergroup) > 50'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: Kafka consumers group (instance {{ $labels.instance }})
          description: "Kafka consumers group\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"